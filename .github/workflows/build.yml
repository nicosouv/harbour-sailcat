name: Build SailCat RPM

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [armv7hl, aarch64, i486]
        include:
          - arch: armv7hl
            device: "Jolla 1, Xperia X, XA2"
          - arch: aarch64
            device: "Xperia 10 II/III/IV"
          - arch: i486
            device: "Emulator"

    container:
      image: coderus/sailfishos-platform-sdk:5.0.0.43
      options: --privileged

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup build environment
        run: |
          echo "Building SailCat for ${{ matrix.arch }}"
          echo "Target devices: ${{ matrix.device }}"

      - name: Build RPM with mb2
        run: |
          mb2 -t SailfishOS-5.0.0.43-${{ matrix.arch }} build

      - name: Find RPM package
        id: find_rpm
        run: |
          RPM_PATH=$(find RPMS -name "*.rpm" -type f | head -n 1)
          echo "rpm_path=$RPM_PATH" >> $GITHUB_OUTPUT
          echo "rpm_name=$(basename $RPM_PATH)" >> $GITHUB_OUTPUT

      - name: Upload RPM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sailcat-${{ matrix.arch }}-rpm
          path: ${{ steps.find_rpm.outputs.rpm_path }}
          if-no-files-found: error

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: rpms

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: rpms/**/*.rpm
          body: |
            ## SailCat ${{ github.ref_name }}

            ### Installation

            Download the RPM for your device architecture:
            - **armv7hl**: Jolla 1, Xperia X, XA2
            - **aarch64**: Xperia 10 II, III, IV
            - **i486**: Emulator

            Transfer to your device and install:
            ```bash
            devel-su pkcon install-local harbour-sailcat-*.rpm
            ```

            ### What's New

            See [README.md](https://github.com/nicosouv/harbour-sailcat/blob/main/README.md) for full documentation.

            ### Configuration

            1. Launch SailCat
            2. Go to Settings
            3. Enter your Mistral API key (get one free at console.mistral.ai)
            4. Start chatting!
          draft: false
          prerelease: false
